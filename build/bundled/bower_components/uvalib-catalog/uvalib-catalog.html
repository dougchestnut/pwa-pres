<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../uvalib-helper-libs/lodash.html">



</head><body><dom-module id="uvalib-catalog">
  <template>
    <iron-ajax id="ajax" auto="[[auto]]" debounce-duration="{{debounceDuration}}" loading="{{loading}}" params="{{_params}}" timeout="{{timeout}}" url="{{_url}}" verbose="{{verbose}}" on-error="_handleError" on-request="_handleRequest" on-response="_handleResponse" handle-as="json"></iron-ajax>
  </template>

  <script>!function(){"use strict";Polymer({is:"uvalib-catalog",properties:{trigger:{type:Boolean,value:!1,observer:"_triggerRequest",notify:!0},auto:{type:Boolean,value:!1},count:{type:Number,value:0,notify:!0,readOnly:!0},debounceDuration:{type:Number,value:0,notify:!0},filters:{type:Array,value:function(){return[{orig:"library_facet",new:"library",name:"Library"},{orig:"format_facet",new:"format",name:"Format"},{orig:"published_date_facet",new:"era",name:"Publication Era"},{orig:"author_facet",new:"author",name:"Author"},{orig:"subject_facet",new:"subject",name:"Subject"},{orig:"language_facet",new:"language",name:"Language"},{orig:"call_number_facet",new:"call_number",name:"Call Number"},{orig:"region_facet",new:"region",name:"Geographic Location"},{orig:"digital_collection_facet",new:"digital_collection",name:"Digital Collection"},{orig:"source_facet",new:"source",name:"Source"},{orig:"series_title_facet",new:"series",name:"Series"}]},notify:!0,readOnly:!0},items:{type:Array,value:[],notify:!0,readOnly:!0},query:{type:String,notify:!0,value:"",observer:"_queryChanged"},timeout:{type:Number,value:0},verbose:{type:Boolean,value:!1},loading:{type:Boolean,notify:!0},rows:{type:Number,notify:!0,value:10,observer:"_rowsChanged"},page:{type:Number,notify:!0,value:1,observer:"_pageChanged"},_url:{type:String,value:"https://api.library.virginia.edu/search/catalog.json"},_params:{type:Object,value:{q:"",per_page:10,page:1},notify:!0},_filterValueMap:{type:Object,value:{}}},ready:function(){},attached:function(){},detached:function(){},_handleError:function(e){this.fire("error",e,{bubbles:!1})},_handleRequest:function(e){this.fire("request",e,{bubbles:!1})},_handleResponse:function(e){this.$.ajax.lastResponse&&(this._setItems(this._mapResults(this.$.ajax.lastResponse.response.docs)),this._setCount(this.$.ajax.lastResponse.response.numFound),this.fire("response",e,{bubbles:!1}))},_queryChanged:function(){this._params&&this.set("_params.q",this.query)},_rowsChanged:function(){this.rows<1&&(this.rows=1),this.count>0&&this.rows>this.count&&(this.rows=this.count),this._params&&this.set("_params.per_page",this.rows)},_pageChanged:function(){this.page<0&&(this.page=0),this._params&&this.set("_params.page",this.page)},_mapResults:function(e){return _.map(e,function(e){var t={id:e.id,tags:[],title:e.title_display.join(", "),author:e.author_display&&e.author_display.length>0?e.author_display.join(", "):"",format:e.format_facet&&e.format_facet.length>0?e.format_facet.join(", "):"",image:"http://search.lib.virginia.edu/catalog/"+e.id+"/image.jpg"};return e.subtitle_display&&e.subtitle_display.length>0&&(t.title+=": "+e.subtitle_display.join(", ")),e.creator_display&&e.creator_display.length>0&&(t.creator=e.creator_display.join(", ")),t})},areFiltersAvailable:function(e){var t=this.getFilters();for(var a in e){var i=_.find(t,{id:a});if(!i)return!1;e[a].forEach(function(e){if(!_.find(i.values,{id:e}))return!1},this)}return!0},emptyFilters:function(){for(var e in this._params)e.startsWith("f[")&&delete this._params[e]},setSelectedFilters:function(e){if(this.emptyFilters(),!_.isEmpty(e))for(var t in e){var a=_.find(this.filters,{new:t});a&&e[t].forEach(function(e){this.set("_params.f["+a.orig+"][]",this._filterValueMap[a.new][e])},this)}},getFilters:function(){return this._mapFilters(this.$.ajax.lastResponse.facet_counts.facet_fields)},_mapFilters:function(e){var t=[];return this.filters.forEach(function(a,i){e[a.orig]&&(this._filterValueMap[a.new]={}),t.push({id:a.new,name:a.name,values:_.map(_.chunk(e[a.orig],2),function(e){var t=e[0].replace(/\s/g,"_").toLowerCase();return this._filterValueMap[a.new][t]=e[0],{id:t,name:e[0],count:e[1]}}.bind(this))})},this),t},_triggerRequest:function(){console.log("trigger request"),this.trigger&&(console.log("trigger"),this.generateRequest())},generateRequest:function(){this.$.ajax.generateRequest()},more:function(){var e=this.page*this.rows;e<this.count&&(this.page+=1,this.auto||this.generateRequest())}})}();</script>
</dom-module>
</body></html>